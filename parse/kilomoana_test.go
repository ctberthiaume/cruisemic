package parse

import (
	"strings"
	"testing"
	"time"

	"github.com/ctberthiaume/cruisemic/storage"
	"github.com/stretchr/testify/assert"
)

type testKMLineData struct {
	name     string
	input    string
	expected map[string][]string
}

func TestKMParserRegistry(t *testing.T) {
	assert := assert.New(t)
	constructor, ok := ParserRegistry["Kilo Moana"]
	assert.True(ok, "Kilo Moana parser is registered")
	if ok {
		p := constructor("testproject", 0, time.Now)
		_, ok = p.(*KiloMoanaParser)
		assert.True(ok, "Kilo Moana parser is registered")
	}
}

func TestKMLines(t *testing.T) {
	testData := []testKMLineData{
		{
			"good stanza",
			`2017 168 00 30 28 990 bar1   1016.07 mbar
2017 168 00 30 28 998 uthsl 19.968599 0.040550 0.217500 27.397800
$GPDTM,W84,,00.0000,N,00.0000,E,,W84*41
$GPGGA,003029.00,2118.9043,N,15752.6526,W,2,7,0.8,27,M,,M,,*78
2017 168 00 30 29 229 rbgm3 024723 00 978906.152511
2017 168 00 30 29 365 flor 78.000000
$GPVTG,47.3,T,37.7,M,0.0,N,0.0,K,D*25
2017 168 00 30 29 909 met  0.000 28.680  50.900 28.470 24.766  3.758 -0.246  1.097  1.099  0.000 5040.000  1.016 11.9 235.0 11.9   83.3 R-  0.000  0.000
2017 169 00 30 30 998 bar1   1016.07 mbar
`,
			map[string][]string{
				"geo": {"2017-06-17T00:30:28.99Z\t19.968599\t0.040550\t0.217500\t27.397800\t47.3\t0.0\t78.000000\t1.016\t21.3151\t-157.8775\n"},
			},
		},
		{
			"2 good stanzas",
			`2017 168 00 30 28 990 bar1   1016.07 mbar
2017 168 00 30 28 998 uthsl 19.968599 0.040550 0.217500 27.397800
$GPDTM,W84,,00.0000,N,00.0000,E,,W84*41
$GPGGA,003029.00,2118.9043,N,15752.6526,W,2,7,0.8,27,M,,M,,*78
2017 168 00 30 29 229 rbgm3 024723 00 978906.152511
2017 168 00 30 29 365 flor 78.000000
$GPVTG,47.3,T,37.7,M,0.0,N,0.0,K,D*25
2017 168 00 30 29 909 met  0.000 28.680  50.900 28.470 24.766  3.758 -0.246  1.097  1.099  0.000 5040.000  1.016 11.9 235.0 11.9   83.3 R-  0.000  0.000
2017 169 00 30 28 990 bar1   1016.07 mbar
2017 169 00 30 28 998 uthsl 20.968599 0.050550 0.227500 28.397800
$GPDTM,W84,,00.0000,N,00.0000,E,,W84*41
$GPGGA,003029.00,2218.9043,N,15852.6526,W,2,7,0.8,27,M,,M,,*78
2017 169 00 30 29 229 rbgm3 024723 00 978906.152511
2017 169 00 30 29 365 flor 79.000000
$GPVTG,48.3,T,37.7,M,1.0,N,0.0,K,D*25
2017 169 00 30 29 909 met  0.000 28.680  50.900 28.470 24.766  3.758 -0.246  1.097  1.099  0.000 5040.000  2.016 11.9 235.0 11.9   83.3 R-  0.000  0.000
2017 170 00 30 30 998 bar1   1016.07 mbar
`,
			map[string][]string{
				"geo": {
					"2017-06-17T00:30:28.99Z\t19.968599\t0.040550\t0.217500\t27.397800\t47.3\t0.0\t78.000000\t1.016\t21.3151\t-157.8775\n",
					"2017-06-18T00:30:28.99Z\t20.968599\t0.050550\t0.227500\t28.397800\t48.3\t1.0\t79.000000\t2.016\t22.3151\t-158.8775\n",
				},
			},
		},
		{
			"bad date",
			`2017 16a8 00 30 28 990 bar1   1016.07 mbar
2017 168 00 30 28 998 uthsl 19.968599 0.040550 0.217500 27.397800
$GPDTM,W84,,00.0000,N,00.0000,E,,W84*41
$GPGGA,003029.00,2118.9043,N,15752.6526,W,2,7,0.8,27,M,,M,,*78
2017 168 00 30 29 229 rbgm3 024723 00 978906.152511
2017 168 00 30 29 365 flor 78.000000
$GPVTG,47.3,T,37.7,M,0.0,N,0.0,K,D*25
2017 168 00 30 29 909 met  0.000 28.680  50.900 28.470 24.766  3.758 -0.246  1.097  1.099  0.000 5040.000  1.016 11.9 235.0 11.9   83.3 R-  0.000  0.000
2017 169 00 30 30 998 bar1   1016.07 mbar
`,
			map[string][]string{},
		},
		{
			"bad lat number",
			`2017 168 00 30 28 990 bar1   1016.07 mbar
2017 168 00 30 28 998 uthsl 19.968599 0.040550 0.217500 27.397800
$GPDTM,W84,,00.0000,N,00.0000,E,,W84*41
$GPGGA,003029.00,21a18.9043,N,15752.6526,W,2,7,0.8,27,M,,M,,*78
2017 168 00 30 29 229 rbgm3 024723 00 978906.152511
2017 168 00 30 29 365 flor 78.000000
$GPVTG,47.3,T,37.7,M,0.0,N,0.0,K,D*25
2017 168 00 30 29 909 met  0.000 28.680  50.900 28.470 24.766  3.758 -0.246  1.097  1.099  0.000 5040.000  1.016 11.9 235.0 11.9   83.3 R-  0.000  0.000
2017 169 00 30 30 998 bar1   1016.07 mbar
`,
			map[string][]string{},
		},
		{
			"bad lat direction",
			`2017 168 00 30 28 990 bar1   1016.07 mbar
2017 168 00 30 28 998 uthsl 19.968599 0.040550 0.217500 27.397800
$GPDTM,W84,,00.0000,N,00.0000,E,,W84*41
$GPGGA,003029.00,2118.9043,A,15752.6526,W,2,7,0.8,27,M,,M,,*78
2017 168 00 30 29 229 rbgm3 024723 00 978906.152511
2017 168 00 30 29 365 flor 78.000000
$GPVTG,47.3,T,37.7,M,0.0,N,0.0,K,D*25
2017 168 00 30 29 909 met  0.000 28.680  50.900 28.470 24.766  3.758 -0.246  1.097  1.099  0.000 5040.000  1.016 11.9 235.0 11.9   83.3 R-  0.000  0.000
2017 169 00 30 30 998 bar1   1016.07 mbar
`,
			map[string][]string{},
		},
		{
			"bad lon number",
			`2017 168 00 30 28 990 bar1   1016.07 mbar
2017 168 00 30 28 998 uthsl 19.968599 0.040550 0.217500 27.397800
$GPDTM,W84,,00.0000,N,00.0000,E,,W84*41
$GPGGA,003029.00,2118.9043,N,15a752.6526,W,2,7,0.8,27,M,,M,,*78
2017 168 00 30 29 229 rbgm3 024723 00 978906.152511
2017 168 00 30 29 365 flor 78.000000
$GPVTG,47.3,T,37.7,M,0.0,N,0.0,K,D*25
2017 168 00 30 29 909 met  0.000 28.680  50.900 28.470 24.766  3.758 -0.246  1.097  1.099  0.000 5040.000  1.016 11.9 235.0 11.9   83.3 R-  0.000  0.000
2017 169 00 30 30 998 bar1   1016.07 mbar
`,
			map[string][]string{},
		},
		{
			"bad lon direction",
			`2017 168 00 30 28 990 bar1   1016.07 mbar
2017 168 00 30 28 998 uthsl 19.968599 0.040550 0.217500 27.397800
$GPDTM,W84,,00.0000,N,00.0000,E,,W84*41
$GPGGA,003029.00,2118.9043,N,15752.6526,A,2,7,0.8,27,M,,M,,*78
2017 168 00 30 29 229 rbgm3 024723 00 978906.152511
2017 168 00 30 29 365 flor 78.000000
$GPVTG,47.3,T,37.7,M,0.0,N,0.0,K,D*25
2017 168 00 30 29 909 met  0.000 28.680  50.900 28.470 24.766  3.758 -0.246  1.097  1.099  0.000 5040.000  1.016 11.9 235.0 11.9   83.3 R-  0.000  0.000
2017 169 00 30 30 998 bar1   1016.07 mbar
`,
			map[string][]string{},
		},
		{
			"bad fluor",
			`2017 168 00 30 28 990 bar1   1016.07 mbar
2017 168 00 30 28 998 uthsl 19.968599 0.040550 0.217500 27.397800
$GPDTM,W84,,00.0000,N,00.0000,E,,W84*41
$GPGGA,003029.00,2118.9043,N,15752.6526,W,2,7,0.8,27,M,,M,,*78
2017 168 00 30 29 229 rbgm3 024723 00 978906.152511
2017 168 00 30 29 365 flor 7a8.000000
$GPVTG,47.3,T,37.7,M,0.0,N,0.0,K,D*25
2017 168 00 30 29 909 met  0.000 28.680  50.900 28.470 24.766  3.758 -0.246  1.097  1.099  0.000 5040.000  1.016 11.9 235.0 11.9   83.3 R-  0.000  0.000
2017 169 00 30 30 998 bar1   1016.07 mbar
`,
			map[string][]string{
				"geo": {"2017-06-17T00:30:28.99Z\t19.968599\t0.040550\t0.217500\t27.397800\t47.3\t0.0\tNA\t1.016\t21.3151\t-157.8775\n"},
			},
		},
		{
			"bad par",
			`2017 168 00 30 28 990 bar1   1016.07 mbar
2017 168 00 30 28 998 uthsl 19.968599 0.040550 0.217500 27.397800
$GPDTM,W84,,00.0000,N,00.0000,E,,W84*41
$GPGGA,003029.00,2118.9043,N,15752.6526,W,2,7,0.8,27,M,,M,,*78
2017 168 00 30 29 229 rbgm3 024723 00 978906.152511
2017 168 00 30 29 365 flor 78.000000
$GPVTG,47.3,T,37.7,M,0.0,N,0.0,K,D*25
2017 168 00 30 29 909 met  0.000 28.680  50.900 28.470 24.766  3.758 -0.246  1.097  1.099  0.000 5040.000  1.a016 11.9 235.0 11.9   83.3 R-  0.000  0.000
2017 169 00 30 30 998 bar1   1016.07 mbar
`,
			map[string][]string{
				"geo": {"2017-06-17T00:30:28.99Z\t19.968599\t0.040550\t0.217500\t27.397800\t47.3\t0.0\t78.000000\tNA\t21.3151\t-157.8775\n"},
			},
		},
		{
			"bad heading",
			`2017 168 00 30 28 990 bar1   1016.07 mbar
2017 168 00 30 28 998 uthsl 19.968599 0.040550 0.217500 27.397800
$GPDTM,W84,,00.0000,N,00.0000,E,,W84*41
$GPGGA,003029.00,2118.9043,N,15752.6526,W,2,7,0.8,27,M,,M,,*78
2017 168 00 30 29 229 rbgm3 024723 00 978906.152511
2017 168 00 30 29 365 flor 78.000000
$GPVTG,4a7.3,T,37.7,M,0.0,N,0.0,K,D*25
2017 168 00 30 29 909 met  0.000 28.680  50.900 28.470 24.766  3.758 -0.246  1.097  1.099  0.000 5040.000  1.016 11.9 235.0 11.9   83.3 R-  0.000  0.000
2017 169 00 30 30 998 bar1   1016.07 mbar
`,
			map[string][]string{
				"geo": {"2017-06-17T00:30:28.99Z\t19.968599\t0.040550\t0.217500\t27.397800\tNA\tNA\t78.000000\t1.016\t21.3151\t-157.8775\n"},
			},
		},
		{
			"bad speed",
			`2017 168 00 30 28 990 bar1   1016.07 mbar
2017 168 00 30 28 998 uthsl 19.968599 0.040550 0.217500 27.397800
$GPDTM,W84,,00.0000,N,00.0000,E,,W84*41
$GPGGA,003029.00,2118.9043,N,15752.6526,W,2,7,0.8,27,M,,M,,*78
2017 168 00 30 29 229 rbgm3 024723 00 978906.152511
2017 168 00 30 29 365 flor 78.000000
$GPVTG,47.3,T,37.7,M,0a.0,N,0.0,K,D*25
2017 168 00 30 29 909 met  0.000 28.680  50.900 28.470 24.766  3.758 -0.246  1.097  1.099  0.000 5040.000  1.016 11.9 235.0 11.9   83.3 R-  0.000  0.000
2017 169 00 30 30 998 bar1   1016.07 mbar
`,
			map[string][]string{
				"geo": {"2017-06-17T00:30:28.99Z\t19.968599\t0.040550\t0.217500\t27.397800\tNA\tNA\t78.000000\t1.016\t21.3151\t-157.8775\n"},
			},
		},
		{
			"bad lab_temp",
			`2017 168 00 30 28 990 bar1   1016.07 mbar
2017 168 00 30 28 998 uthsl 19.a968599 0.040550 0.217500 27.397800
$GPDTM,W84,,00.0000,N,00.0000,E,,W84*41
$GPGGA,003029.00,2118.9043,N,15752.6526,W,2,7,0.8,27,M,,M,,*78
2017 168 00 30 29 229 rbgm3 024723 00 978906.152511
2017 168 00 30 29 365 flor 78.000000
$GPVTG,47.3,T,37.7,M,0.0,N,0.0,K,D*25
2017 168 00 30 29 909 met  0.000 28.680  50.900 28.470 24.766  3.758 -0.246  1.097  1.099  0.000 5040.000  1.016 11.9 235.0 11.9   83.3 R-  0.000  0.000
2017 169 00 30 30 998 bar1   1016.07 mbar
`,
			map[string][]string{"geo": {"2017-06-17T00:30:28.99Z\tNA\tNA\tNA\tNA\t47.3\t0.0\t78.000000\t1.016\t21.3151\t-157.8775\n"}},
		},
		{
			"bad conductivity",
			`2017 168 00 30 28 990 bar1   1016.07 mbar
2017 168 00 30 28 998 uthsl 19.968599 0.0a40550 0.217500 27.397800
$GPDTM,W84,,00.0000,N,00.0000,E,,W84*41
$GPGGA,003029.00,2118.9043,N,15752.6526,W,2,7,0.8,27,M,,M,,*78
2017 168 00 30 29 229 rbgm3 024723 00 978906.152511
2017 168 00 30 29 365 flor 78.000000
$GPVTG,47.3,T,37.7,M,0.0,N,0.0,K,D*25
2017 168 00 30 29 909 met  0.000 28.680  50.900 28.470 24.766  3.758 -0.246  1.097  1.099  0.000 5040.000  1.016 11.9 235.0 11.9   83.3 R-  0.000  0.000
2017 169 00 30 30 998 bar1   1016.07 mbar
`,
			map[string][]string{"geo": {"2017-06-17T00:30:28.99Z\tNA\tNA\tNA\tNA\t47.3\t0.0\t78.000000\t1.016\t21.3151\t-157.8775\n"}},
		},
		{
			"bad salinity",
			`2017 168 00 30 28 990 bar1   1016.07 mbar
2017 168 00 30 28 998 uthsl 19.968599 0.040550 0.21a7500 27.397800
$GPDTM,W84,,00.0000,N,00.0000,E,,W84*41
$GPGGA,003029.00,2118.9043,N,15752.6526,W,2,7,0.8,27,M,,M,,*78
2017 168 00 30 29 229 rbgm3 024723 00 978906.152511
2017 168 00 30 29 365 flor 78.000000
$GPVTG,47.3,T,37.7,M,0.0,N,0.0,K,D*25
2017 168 00 30 29 909 met  0.000 28.680  50.900 28.470 24.766  3.758 -0.246  1.097  1.099  0.000 5040.000  1.016 11.9 235.0 11.9   83.3 R-  0.000  0.000
2017 169 00 30 30 998 bar1   1016.07 mbar
`,
			map[string][]string{"geo": {"2017-06-17T00:30:28.99Z\tNA\tNA\tNA\tNA\t47.3\t0.0\t78.000000\t1.016\t21.3151\t-157.8775\n"}},
		},
		{
			"bad bow_temp",
			`2017 168 00 30 28 990 bar1   1016.07 mbar
2017 168 00 30 28 998 uthsl 19.968599 0.040550 0.217500 27.3a97800
$GPDTM,W84,,00.0000,N,00.0000,E,,W84*41
$GPGGA,003029.00,2118.9043,N,15752.6526,W,2,7,0.8,27,M,,M,,*78
2017 168 00 30 29 229 rbgm3 024723 00 978906.152511
2017 168 00 30 29 365 flor 78.000000
$GPVTG,47.3,T,37.7,M,0.0,N,0.0,K,D*25
2017 168 00 30 29 909 met  0.000 28.680  50.900 28.470 24.766  3.758 -0.246  1.097  1.099  0.000 5040.000  1.016 11.9 235.0 11.9   83.3 R-  0.000  0.000
2017 169 00 30 30 998 bar1   1016.07 mbar
`,
			map[string][]string{"geo": {"2017-06-17T00:30:28.99Z\tNA\tNA\tNA\tNA\t47.3\t0.0\t78.000000\t1.016\t21.3151\t-157.8775\n"}},
		},
	}
	for _, tt := range testData {
		t.Run(tt.name, createKMLinesTest(t, tt))
	}
}

func createKMLinesTest(t *testing.T, tt testKMLineData) func(*testing.T) {
	assert := assert.New(t)

	return func(t *testing.T) {
		p := NewKiloMoanaParser("test", 0, time.Now)
		store, _ := storage.NewMemStorage()
		r := strings.NewReader(tt.input)
		err := ParseLines(p, r, store, true, false)
		assert.Nil(err, "writing for test: "+tt.name)
		// No need to check the raw feed
		//delete(store.Feeds, "raw")

		assert.Equal(tt.expected, store.Feeds, tt.name)
	}
}
